<div class="briefing-container">
  <div class="briefing-wrapper">
    <div id="briefing-container"
         data-controller="briefing"
         data-briefing-user-id-value="<%= @user_id %>"
         data-briefing-date-value="<%= @date.iso8601 %>"
         data-briefing-prev-date-value="<%= @prev_date %>"
         data-briefing-next-date-value="<%= @next_date %>"
         data-briefing-can-go-next-value="<%= @can_go_next %>">

      <!-- Loading State -->
      <div id="loading-state" class="hidden">
        <div class="briefing-card briefing-loading">
          <div class="briefing-header">
            <div class="loading-skeleton" style="height: 1.5rem; width: 12rem;"></div>
            <div class="loading-skeleton" style="height: 1rem; width: 8rem; margin-top: 0.5rem;"></div>
          </div>
          <div style="margin-top: 1.5rem;">
            <div class="loading-skeleton" style="height: 6rem;"></div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="content-state" class="briefing-card">
        <!-- Token Display (top-right caption) -->
        <% if @briefing&.generated? %>
          <div id="token-display" class="token-display">
            <span class="token-model"><%= @briefing.model&.split('/')&.last || '...' %></span>
            <span class="token-separator">·</span>
            <span class="token-count"><%= number_to_human(@briefing.total_tokens, precision: 1, significant: false, units: { thousand: 'k' }) %></span>
            <span class="token-label">tokens</span>
          </div>
        <% else %>
          <div id="token-display" class="token-display hidden">
            <span class="token-model">...</span>
            <span class="token-separator">·</span>
            <span class="token-count">0</span>
            <span class="token-label">tokens</span>
          </div>
        <% end %>

        <!-- Header with Navigation -->
        <header class="briefing-header">
          <div class="briefing-nav">
            <button class="nav-btn" data-action="click->briefing#prevDay" title="Previous day">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <div class="briefing-title-group">
              <h1 id="greeting" class="briefing-greeting">Daily Briefing</h1>
              <p id="briefing-date" class="briefing-date"><%= @date.strftime('%A, %B %-d, %Y') %></p>
            </div>
            <button class="nav-btn" data-action="click->briefing#nextDay" id="next-btn" <%= 'disabled' unless @can_go_next %> title="Next day">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
          </div>
        </header>

        <!-- Status (single consolidated block) -->
        <section id="status-container">
          <% if @briefing&.generated? %>
            <% output = @briefing.output.deep_symbolize_keys %>
            <% status = output[:status] %>
            <% metrics = (status[:metrics] || []).map { |m| { label: m[:label], value: m[:value], trend: m[:trend]&.to_sym } } %>
            <%= render Briefing::StatusSummaryComponent.new(
              headline: status[:headline],
              summary: status[:summary],
              sentiment: status[:sentiment].to_sym,
              metrics: metrics
            ) %>
          <% end %>
        </section>

        <!-- Suggestions -->
        <section id="suggestions-section" class="suggestions-section <%= 'hidden' unless @briefing&.generated? && @briefing.output.dig('suggestions')&.any? %>">
          <h2 class="suggestions-header">What to do today</h2>
          <div id="suggestions-container">
            <% if @briefing&.generated? %>
              <% output = @briefing.output.deep_symbolize_keys %>
              <% (output[:suggestions] || []).each do |suggestion| %>
                <%= render Briefing::SuggestionComponent.new(
                  title: suggestion[:title],
                  body: suggestion[:body],
                  suggestion_type: suggestion[:suggestion_type]&.to_sym || :general
                ) %>
              <% end %>
            <% end %>
          </div>
        </section>

        <!-- Action Bar -->
        <div class="action-bar" id="action-bar">
          <button id="generate-btn"
                  data-action="click->briefing#generate"
                  class="btn btn-primary">
            <%= @briefing&.generated? ? 'Regenerate Briefing' : 'Generate Briefing' %>
          </button>
        </div>

        <!-- Warning State -->
        <div id="warning-state" class="hidden">
          <div class="status-card status-card--warning">
            <p id="warning-message" class="status-text"></p>
          </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
          <div class="status-card status-card--warning">
            <p id="error-message" class="status-text"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

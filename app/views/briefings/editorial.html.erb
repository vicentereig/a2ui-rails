<%= stylesheet_link_tag "editorial", "data-turbo-track": "reload" %>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Newsreader:opsz,wght@6..72,400;6..72,500&family=Source+Serif+4:opsz,wght@8..60,400;8..60,500&display=swap" rel="stylesheet">

<div class="editorial-container">
  <div class="editorial-wrapper">
    <div id="briefing-container"
         data-controller="editorial-briefing"
         data-editorial-briefing-user-id-value="<%= @user_id %>"
         data-editorial-briefing-date-value="<%= @date.iso8601 %>"
         data-editorial-briefing-prev-date-value="<%= @prev_date %>"
         data-editorial-briefing-next-date-value="<%= @next_date %>"
         data-editorial-briefing-can-go-next-value="<%= @can_go_next %>">

      <!-- Loading State -->
      <div id="loading-state" class="hidden">
        <div class="editorial-page">
          <div class="editorial-loading">
            <div class="editorial-skeleton editorial-skeleton--headline"></div>
            <div class="editorial-skeleton editorial-skeleton--text"></div>
            <div class="editorial-skeleton editorial-skeleton--text"></div>
            <div class="editorial-skeleton editorial-skeleton--text-short"></div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div id="content-state">
        <!-- Navigation -->
        <div class="editorial-nav">
          <button class="editorial-nav__btn" data-action="click->editorial-briefing#prevDay" title="Previous day">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button class="editorial-nav__btn" data-action="click->editorial-briefing#nextDay" id="next-btn" <%= 'disabled' unless @can_go_next %> title="Next day">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>

        <!-- Metadata Bar -->
        <div class="editorial-meta-bar">
          <span class="editorial-meta-bar__date"><%= @date.strftime('%A, %B %-d, %Y') %></span>
          <div class="editorial-meta" id="editorial-meta">
            <span class="editorial-meta__dot" id="activity-dot"></span>
            <span class="editorial-meta__model" id="model-name"><%= @briefing&.model&.split('/')&.last || '...' %></span>
            <span class="editorial-meta__separator">·</span>
            <span class="editorial-meta__tokens">
              <span id="input-tokens"><%= @briefing&.input_tokens || 0 %></span>↓
              <span id="output-tokens"><%= @briefing&.output_tokens || 0 %></span>↑
            </span>
          </div>
        </div>

        <!-- Editorial Content -->
        <div id="editorial-content">
          <% if @briefing&.generated? %>
            <% output = @briefing.output.deep_symbolize_keys %>
            <% if output[:surface_id] && output[:components] %>
              <%# A2UI Surface format - render dynamically %>
              <div class="editorial-page a2ui-surface" data-surface-id="<%= output[:surface_id] %>">
                <% surface = BriefingChannel.reconstruct_surface(output) %>
                <% if (root_component = A2UI::Components::Renderer.render_surface(surface)) %>
                  <%= render root_component %>
                <% else %>
                  <p class="text-gray-500">No content available</p>
                <% end %>
              </div>
            <% else %>
              <%# Legacy format - render static content %>
              <article class="editorial-page" data-tone="<%= output[:tone] || 'neutral' %>">
                <h1 class="editorial-headline"><%= output[:headline] %></h1>

                <div class="editorial-insight">
                  <% insight = output[:insight] || {} %>
                  <p>
                    <%= insight[:what] %>
                    <%= insight[:so_what] %>
                  </p>
                  <% if insight[:now_what].present? %>
                    <p class="editorial-insight__action"><%= insight[:now_what] %></p>
                  <% end %>
                </div>

                <% metrics = output[:supporting_metrics] || [] %>
                <% if metrics.any? %>
                  <hr class="editorial-divider">
                  <div class="editorial-metrics">
                    <% metrics.each do |metric| %>
                      <div class="editorial-metric">
                        <span class="editorial-metric__label"><%= metric[:label] %></span>
                        <span class="editorial-metric__value">
                          <%= metric[:value] %>
                          <% if metric[:trend] %>
                            <% trend_class = case metric[:trend].to_sym
                               when :up then 'editorial-metric__trend--up'
                               when :down then 'editorial-metric__trend--down'
                               else 'editorial-metric__trend--stable'
                               end %>
                            <% trend_icon = case metric[:trend].to_sym
                               when :up then '↑'
                               when :down then '↓'
                               else '→'
                               end %>
                            <span class="editorial-metric__trend <%= trend_class %>"><%= trend_icon %></span>
                          <% end %>
                        </span>
                        <% if metric[:context].present? %>
                          <span class="editorial-metric__context"><%= metric[:context] %></span>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </article>
            <% end %>
          <% else %>
            <div class="editorial-page" data-tone="neutral">
              <h1 class="editorial-headline">Your Daily Briefing</h1>
              <div class="editorial-insight">
                <p>Generate your personalized health briefing to see insights from your Garmin data.</p>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Action Bar -->
        <div class="editorial-actions" id="action-bar">
          <button id="generate-btn"
                  data-action="click->editorial-briefing#generate"
                  class="editorial-generate">
            <%= @briefing&.generated? ? 'Regenerate' : 'Generate Briefing' %>
          </button>
        </div>

        <!-- Warning State -->
        <div id="warning-state" class="hidden">
          <div class="editorial-message editorial-message--warning">
            <p id="warning-message"></p>
          </div>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden">
          <div class="editorial-message editorial-message--error">
            <p id="error-message"></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
